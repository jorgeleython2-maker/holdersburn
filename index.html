<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="pageTitle">Welcome to burn • Detectando token...</title>
  <link rel="icon" href="https://i.ibb.co.com/0jZ6g3f/fire.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --orange: #FF6B00; --red: #FF0000; --dark: #111; --bg: #000; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; overflow-x:hidden; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 25px 0; border-bottom: 1px solid #333; }
    .title { display: flex; align-items: center; gap: 18px; }
    .fire-icon { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--orange); box-shadow: 0 0 20px rgba(255,107,0,0.4); }
    h1 { font-size: 32px; font-weight: 800; background: linear-gradient(90deg, #fff, var(--orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .connect-btn { background: var(--orange); color: white; border: none; padding: 14px 28px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s; }
    .dev-wallet, .user-tokens { text-align: center; margin: 25px 0; padding: 18px; background: rgba(255,107,0,0.1); border-radius: 16px; color: var(--orange); font-weight: bold; font-size: 17px; }
    .user-tokens { display: none; background: rgba(255,107,0,0.15); font-size: 20px; }
    .center-section { text-align: center; margin: 60px 0; }
    .jackpot { font-size: 42px; font-weight: 800; color: var(--orange); }
    .timer { font-size: 32px; margin: 25px 0; color: var(--orange); font-weight: bold; }
    .start-burning { background: var(--red); color: white; border: none; padding: 22px 60px; font-size: 28px; border-radius: 16px; cursor: pointer; font-weight: bold; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.97); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--dark); padding: 50px 30px; border-radius: 20px; max-width: 420px; width: 90%; border: 3px solid var(--orange); position: relative; }
    .close { position: absolute; top: 15px; right: 25px; font-size: 36px; cursor: pointer; color: #aaa; }
    .presets button { background: #333; color: white; border: none; padding: 14px 22px; border-radius: 12px; margin: 6px; cursor: pointer; font-weight: bold; }
    input { width: 100%; padding: 20px; margin: 20px 0; border-radius: 14px; background: #222; color: white; font-size: 20px; text-align: center; border: none; }
    .burn-btn { background: var(--red); color: white; border: none; padding: 22px; width: 100%; font-size: 26px; border-radius: 16px; cursor: pointer; font-weight: bold; margin: 25px 0; }
    .warning { color: var(--orange); font-size: 15px; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <img id="tokenLogo" src="https://i.ibb.co.com/0jZ6g3f/fire.png" class="fire-icon">
        <div>
          <h1 id="tokenName">Welcome to burn • Detectando token...</h1>
          <p>Burn-to-Win Real • Quema tokens y gana SOL cada 20 segundos</p>
        </div>
      </div>
      <button id="connectWallet" class="connect-btn">Connect Wallet</button>
    </header>

    <div class="dev-wallet" id="devWalletDisplay">Dev Wallet: Cargando...</div>
    <div class="user-tokens" id="userTokensDisplay">Tienes <strong id="userBalance">0</strong> tokens</div>

    <div class="center-section">
      <div class="jackpot">Jackpot Actual: <span id="jackpot">0.0000</span> SOL</div>
      <div class="timer">Próximo ganador en: <span id="timer">05:00</span></div>
      <button id="openBurnModal" class="start-burning">QUEMAR TOKENS</button>
    </div>
  </div>

  <div id="burnModal" class="modal">
    <div class="modal-content">
      <span class="close">×</span>
      <h2>QUEMAR TOKENS</h2>
      <p>Elige cuántos tokens quieres quemar</p>
      <div class="presets">
        <button onclick="document.getElementById('customAmount').value='10000'">10K</button>
        <button onclick="document.getElementById('customAmount').value='50000'">50K</button>
        <button onclick="document.getElementById('customAmount').value='100000'">100K</button>
        <button onclick="document.getElementById('customAmount').value='500000'">500K</button>
        <button onclick="document.getElementById('customAmount').value='1000000'">1M</button>
      </div>
      <input type="number" id="customAmount" placeholder="Cantidad exacta" />
      <button id="burnNow" class="burn-btn">QUEMAR & PARTICIPAR</button>
      <p class="warning">Los tokens serán quemados permanentemente</p>
    </div>
  </div>

  <!-- LIBRERÍAS SOLANA -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.1/dist/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.8/lib/index.iife.min.js"></script>

  <!-- TODO EL CÓDIGO JS AQUÍ (SIN app.js SEPARADO) -->
  <script>
    const BACKEND_URL = "https://spin-production-ddc0.up.railway.app";

    // RPCs RÁPIDOS
    const RPCS = ["https://rpc.ankr.com/solana", "https://solana-api.projectserum.com", "https://api.mainnet-beta.solana.com"];

    let userWallet = null;
    let tokenMint = null;
    let userBalance = 0;
    let connection = null;

    // ESPERAR QUE CARGUEN LAS LIBRERÍAS
    async function waitForLibs() {
      while (!window.solanaWeb3 || !window.splToken) {
        await new Promise(r => setTimeout(r, 100));
      }
      console.log("Librerías Solana cargadas");
    }

    // CONEXIÓN RÁPIDA
    async function getConnection() {
      for (const rpc of RPCS) {
        try {
          const conn = new window.solanaWeb3.Connection(rpc);
          await conn.getSlot();
          connection = conn;
          return conn;
        } catch (e) {}
      }
      connection = new window.solanaWeb3.Connection("https://api.mainnet-beta.solana.com");
      return connection;
    }

    // CONECTAR WALLET
    document.getElementById("connectWallet").onclick = async () => {
      if (!window.solana?.isPhantom) return alert("Instala Phantom Wallet");
      try {
        await window.solana.connect();
        userWallet = window.solana.publicKey.toString();
        document.getElementById("connectWallet").innerText = userWallet.slice(0,6)+"..."+userWallet.slice(-4);
        await waitForLibs();
        await getConnection();
        cargarTodo();
      } catch (e) { console.log("Cancelado"); }
    };

    // DETECTAR BALANCE CON REINTENTOS
    async function updateUserBalance() {
      if (!userWallet || !tokenMint || !connection) return;
      try {
        const accounts = await connection.getTokenAccountsByOwner(
          new window.solanaWeb3.PublicKey(userWallet),
          { mint: new window.solanaWeb3.PublicKey(tokenMint) }
        );
        userBalance = 0;
        if (accounts.value.length > 0) {
          userBalance = Number(accounts.value[0].account.data.parsed.info.tokenAmount.uiAmount) || 0;
        }
        document.getElementById("userBalance").innerText = userBalance.toLocaleString();
        document.getElementById("userTokensDisplay").style.display = "block";
      } catch (e) {
        setTimeout(updateUserBalance, 3000);
      }
    }

    // QUEMAR TOKENS (100% FUNCIONAL)
    document.getElementById("burnNow").onclick = async () => {
      if (!userWallet) return alert("Conecta tu wallet");
      if (userBalance <= 0) return alert("No tienes tokens");
      const amount = parseFloat(document.getElementById("customAmount").value);
      if (!amount || amount > userBalance) return alert("Cantidad inválida");

      try {
        alert(`Quemando ${amount.toLocaleString()} tokens...`);
        const mint = new window.solanaWeb3.PublicKey(tokenMint);
        const owner = new window.solanaWeb3.PublicKey(userWallet);
        const ata = await window.splToken.getAssociatedTokenAddress(mint, owner);

        const tx = new window.solanaWeb3.Transaction();
        const ataInfo = await connection.getAccountInfo(ata);
        if (!ataInfo) {
          tx.add(window.splToken.createAssociatedTokenAccountInstruction(owner, ata, owner, mint));
        }
        tx.add(window.splToken.createBurnInstruction(
          ata, mint, owner,
          BigInt(Math.floor(amount * 1_000_000_000)), // 9 decimales
          [], window.splToken.TOKEN_PROGRAM_ID
        ));

        tx.feePayer = owner;
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

        const signed = await window.solana.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        await connection.confirmTransaction(sig);

        alert(`¡QUEMADOS ${amount.toLocaleString()} TOKENS!\nhttps://solscan.io/tx/${sig}`);
        document.getElementById("customAmount").value = "";
        updateUserBalance();
      } catch (err) {
        alert("Error: " + (err.message || "Transacción cancelada"));
      }
    };

    // CARGAR TODO DESDE BACKEND
    async function cargarTodo() {
      try {
        const token = await (await fetch(`${BACKEND_URL}/api/token`)).json();
        if (token.mint) {
          tokenMint = token.mint;
          document.getElementById("tokenName").innerHTML = `Welcome to burn • $${token.symbol || "TOKEN"}`;
          document.getElementById("tokenLogo").src = token.image || "https://i.ibb.co.com/0jZ6g3f/fire.png";
          document.getElementById("devWalletDisplay").innerHTML = `Dev Wallet: <strong>${token.creator.slice(0,6)}...${token.creator.slice(-4)}</strong>`;
          if (userWallet) updateUserBalance();
        }
        const jackpot = await (await fetch(`${BACKEND_URL}/api/jackpot`)).json();
        document.getElementById("jackpot").innerText = Number(jackpot.jackpot).toFixed(4);
      } catch (e) {}
    }

    // TIMER
    let time = 300;
    setInterval(() => {
      time--; if (time <= 0) time = 300;
      const m = String(Math.floor(time/60)).padStart(2,"0");
      const s = String(time%60).padStart(2,"0");
      document.getElementById("timer").innerText = m+":"+s;
    }, 1000);

    // MODAL
    document.getElementById("openBurnModal").onclick = () => document.getElementById("burnModal").style.display = "flex";
    document.querySelector(".close").onclick = () => document.getElementById("burnModal").style.display = "none";

    // INICIAR
    waitForLibs().then(() => {
      getConnection();
      cargarTodo();
      setInterval(cargarTodo, 10000);
    });
  </script>
</body>
</html>